{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-end justify-between gap-4">
        <div>
            <h2 class="text-xl font-semibold text-gray-100">Wallet scorecard</h2>
            <a href="https://polymarket.com/profile/{{ journey.proxy_wallet }}" target="_blank" rel="noopener" class="text-sm text-blue-400 hover:text-blue-300 font-mono" title="{{ journey.proxy_wallet }}">{{ journey.wallet_display_label }}</a>
        </div>
        <a class="text-sm text-blue-400 hover:text-blue-300" href="/">Back</a>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="bg-gray-800/50 rounded-lg p-3">
            <div class="text-xs text-gray-500">Persona</div>
            <div class="text-sm text-gray-200">
                {% match journey.persona %}
                {% when Some with (p) %}{{ p }}
                {% when None %}N/A
                {% endmatch %}
            </div>
            <div class="text-xs text-gray-500">
                {% match journey.confidence_display %}
                {% when Some with (c) %}confidence: {{ c }}
                {% when None %}{% endmatch %}
            </div>
        </div>
        <div class="bg-gray-800/50 rounded-lg p-3">
            <div class="text-xs text-gray-500">Paper PnL</div>
            <div class="text-sm text-gray-200">{{ journey.paper_pnl_display }}</div>
        </div>
        <div class="bg-gray-800/50 rounded-lg p-3">
            <div class="text-xs text-gray-500">Exposure</div>
            <div class="text-sm text-gray-200">{{ journey.exposure_display }}</div>
        </div>
        <div class="bg-gray-800/50 rounded-lg p-3">
            <div class="text-xs text-gray-500">Copy Fidelity</div>
            <div class="text-sm text-gray-200">{{ journey.copy_fidelity_display }}</div>
        </div>
    </div>

    <div class="text-sm text-gray-500">
        <span class="text-gray-400">Last trades ingestion:</span>
        {% match journey.last_trades_ingestion_at %}
        {% when Some with (t) %}{{ t }}
        {% when None %}never
        {% endmatch %}
        <span class="text-gray-600 ml-1">(we never have all trades; this is when we last fetched for this wallet)</span>
    </div>

    <div class="bg-gray-900 rounded-lg p-4">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-200">Timeline</h3>
            <div class="text-xs text-gray-500">Discovered: {{ journey.discovered_at }}</div>
        </div>

        {% if journey.events.is_empty() %}
        <p class="text-gray-500 text-sm italic mt-3">No journey events yet.</p>
        {% else %}
        <ul class="mt-3 space-y-2">
            {% for e in journey.events %}
            <li class="flex items-start gap-3">
                <div class="font-mono text-xs text-gray-500 w-40 shrink-0">{{ e.at }}</div>
                <div>
                    <div class="text-sm text-gray-200">{{ e.label }}</div>
                    <div class="text-xs text-gray-500">{{ e.detail }}</div>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <div class="bg-gray-900 rounded-lg p-4">
        <h3 class="text-lg font-semibold text-gray-200">All trades ({{ journey.total_trades_count }})</h3>
        {% if journey.trades.is_empty() %}
        <p class="text-gray-500 text-sm italic mt-3">No trades for this wallet yet.</p>
        {% else %}
        <p class="text-gray-500 text-xs mt-1">Showing first 20; scroll down to load more.</p>
        <div class="mt-3 overflow-x-auto max-h-[70vh] overflow-y-auto" id="trades-container">
            <table class="w-full text-sm">
                <thead class="sticky top-0 bg-gray-900 z-10">
                    <tr class="text-left text-gray-500 border-b border-gray-700">
                        <th class="pb-2 pr-4">Time</th>
                        <th class="pb-2 pr-4">Market</th>
                        <th class="pb-2 pr-4">Side</th>
                        <th class="pb-2 pr-4">Size</th>
                        <th class="pb-2 pr-4">Price</th>
                        <th class="pb-2">Outcome</th>
                    </tr>
                </thead>
                <tbody id="trades-tbody">
                    {% for t in journey.trades %}
                    <tr class="border-b border-gray-800 text-gray-300">
                        <td class="py-2 pr-4 font-mono text-xs">{{ t.timestamp_display }}</td>
                        <td class="py-2 pr-4 max-w-xs truncate" title="{{ t.condition_id }}">
                            {% match t.market_title %}
                            {% when Some with (title) %}{{ title }}
                            {% when None %}<span class="text-gray-500 font-mono">{{ t.condition_id }}</span>
                            {% endmatch %}
                        </td>
                        <td class="py-2 pr-4">{{ t.side }}</td>
                        <td class="py-2 pr-4">{{ t.size_display }}</td>
                        <td class="py-2 pr-4">{{ t.price_display }}</td>
                        <td class="py-2">{% match t.outcome %}{% when Some with (o) %}{{ o }}{% when None %}—{% endmatch %}</td>
                    </tr>
                    {% endfor %}
                    {% if journey.total_trades_count > journey.trades.len() %}
                    <tr id="trades-sentinel" class="border-b border-gray-800 text-gray-500" data-wallet="{{ journey.proxy_wallet }}" data-offset="20" data-limit="20" data-total="{{ journey.total_trades_count }}">
                        <td colspan="6" class="py-4 text-center text-xs">Scroll to load more…</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    {% if !journey.trades.is_empty() && journey.total_trades_count > journey.trades.len() %}
    <script>
    (function() {
        var sentinel = document.getElementById('trades-sentinel');
        var tbody = document.getElementById('trades-tbody');
        var container = document.getElementById('trades-container');
        if (!sentinel || !tbody || !container) return;
        var loading = false;
        function loadMore() {
            if (loading) return;
            var wallet = sentinel.getAttribute('data-wallet');
            var offset = parseInt(sentinel.getAttribute('data-offset'), 10);
            var limit = parseInt(sentinel.getAttribute('data-limit'), 10);
            var total = parseInt(sentinel.getAttribute('data-total'), 10);
            if (offset >= total) return;
            loading = true;
            sentinel.querySelector('td').textContent = 'Loading…';
            fetch('/wallet/' + encodeURIComponent(wallet) + '/trades?offset=' + offset + '&limit=' + limit)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    data.trades.forEach(function(t) {
                        var tr = document.createElement('tr');
                        tr.className = 'border-b border-gray-800 text-gray-300';
                        var title = t.market_title != null ? escapeHtml(t.market_title) : '<span class="text-gray-500 font-mono">' + escapeHtml(t.condition_id) + '</span>';
                        var outcome = t.outcome != null ? escapeHtml(t.outcome) : '—';
                        tr.innerHTML = '<td class="py-2 pr-4 font-mono text-xs">' + escapeHtml(t.timestamp_display) + '</td>' +
                            '<td class="py-2 pr-4 max-w-xs truncate" title="' + escapeHtml(t.condition_id) + '">' + title + '</td>' +
                            '<td class="py-2 pr-4">' + escapeHtml(t.side) + '</td>' +
                            '<td class="py-2 pr-4">' + escapeHtml(t.size_display) + '</td>' +
                            '<td class="py-2 pr-4">' + escapeHtml(t.price_display) + '</td>' +
                            '<td class="py-2">' + outcome + '</td>';
                        tbody.insertBefore(tr, sentinel);
                    });
                    var nextOffset = offset + data.trades.length;
                    sentinel.setAttribute('data-offset', nextOffset);
                    if (nextOffset >= data.total || data.trades.length < limit) {
                        sentinel.remove();
                    } else {
                        sentinel.querySelector('td').textContent = 'Scroll to load more…';
                    }
                })
                .catch(function() { sentinel.querySelector('td').textContent = 'Error loading more.'; })
                .finally(function() { loading = false; });
        }
        function escapeHtml(s) {
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }
        var observer = new IntersectionObserver(function(entries) {
            if (entries[0].isIntersecting) loadMore();
        }, { root: container, rootMargin: '100px', threshold: 0 });
        observer.observe(sentinel);
    })();
    </script>
    {% endif %}
</div>
{% endblock %}
